<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:include="common/header"></th:block>

<link rel="stylesheet" href="/css/member/myMedicalHistory.css">

	<!-- container -->
    <main id="container" class="container myMedicalHistory">

		<!-- contents -->
        <section id="contents" class="contents">
            <div class="inner_wrap">
                <h2>내 진료내역</h2>
                <!-- <p th:if="${session.member != null}" th:text="${session.member.memberName}">세션이 있냐</p> -->

                <div class="history_area">
                    <div class="history_wrap">
                        <p class="history_info_txt">진료내역은 최신순으로 노출됩니다.</p>
                        <ul class="history_list">
                            <!-- <li>
                                <a href="#">
                                    <div class="badge_area">
                                        <span class="badge blue outline">접수대기</span>
                                        <span class="res_type badge contact">대면진료</span>
                                        <span class="name">홍길동</span>
                                    </div>
                                    <div class="info_area">
                                        <strong class="hospital_name">강서송도병원</strong>
                                        <div class="res_time">
                                            <span class="res_time_date">2024-01-01</span>
                                            <span class="res_time_day">(목)</span>
                                            <span class="res_time_time">09:30</span>
                                        </div>
                                    </div>
                                    <div class="btn_area">
                                        <button type="button" class="btn_secondary">예약 취소</button>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <div class="badge_area">
                                        <span class="badge red outline">예약취소</span>
                                        <span class="res_type badge contactless">비대면진료</span>
                                        <span class="name">홍길동</span>
                                    </div>
                                    <div class="info_area">
                                        <strong class="hospital_name">강서송도병원</strong>
                                        <div class="res_time">
                                            <span class="res_time_date">2024-01-01</span>
                                            <span class="res_time_day">(목)</span>
                                            <span class="res_time_time">09:30</span>
                                        </div>
                                    </div>
                                    <div class="btn_area">
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <div class="badge_area">
                                        <span class="badge blue">예약확정</span>
                                        <span class="res_type badge contact">대면진료</span>
                                        <span class="name">홍길동</span>
                                    </div>
                                    <div class="info_area">
                                        <strong class="hospital_name">강서송도병원</strong>
                                        <div class="res_time">
                                            <span class="res_time_date">2024-01-01</span>
                                            <span class="res_time_day">(목)</span>
                                            <span class="res_time_time">09:30</span>
                                        </div>
                                    </div>
                                    <div class="btn_area">
                                        <button type="button" class="btn_secondary">예약 취소</button>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <div class="badge_area">
                                        <span class="badge gray">진료완료</span>
                                        <span class="res_type badge contact">대면진료</span>
                                        <span class="name">홍길동</span>
                                    </div>
                                    <div class="info_area">
                                        <strong class="hospital_name">강서송도병원</strong>
                                        <div class="res_time">
                                            <span class="res_time_date">2024-01-01</span>
                                            <span class="res_time_day">(목)</span>
                                            <span class="res_time_time">09:30</span>
                                        </div>
                                    </div>
                                    <div class="btn_area">
                                        <button type="button" class="btn_primary outline">리뷰 쓰기</button>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <div class="badge_area">
                                        <span class="badge gray">진료완료</span>
                                        <span class="res_type badge contactless">비대면진료</span>
                                        <span class="name">홍길동</span>
                                    </div>
                                    <div class="info_area">
                                        <strong class="hospital_name">강서송도병원</strong>
                                        <div class="res_time">
                                            <span class="res_time_date">2024-01-01</span>
                                            <span class="res_time_day">(목)</span>
                                            <span class="res_time_time">09:30</span>
                                        </div>
                                    </div>
                                    <div class="btn_area">
                                        <button type="button" class="btn_primary outline">수납하기</button>
                                    </div>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    <div class="badge_area">
                                        <span class="badge gray">진료완료</span>
                                        <span class="res_type badge contactless">비대면진료</span>
                                        <span class="name">홍길동</span>
                                    </div>
                                    <div class="info_area">
                                        <strong class="hospital_name">강서송도병원</strong>
                                        <div class="res_time">
                                            <span class="res_time_date">2024-01-01</span>
                                            <span class="res_time_day">(목)</span>
                                            <span class="res_time_time">09:30</span>
                                        </div>
                                    </div>
                                    <div class="btn_area">
                                        <button type="button" class="btn_primary">처방전 보기</button>
                                        <button type="button" class="btn_primary outline">리뷰 쓰기</button>
                                    </div>
                                </a>
                            </li> -->
                        </ul>

                        <div class="btn_area">
                            <button type="button" id="viewMore" class="btn_secondary out_line view_more">더보기</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!--// contents -->
        
    </main>
    <!--// container -->
	
<th:block th:include="common/footer"></th:block>
<!-- js 링크 -->
<script th:inline="javascript">
    const memberNo = [[${session.member.memberNo}]];
    const totalCount = [[${totalCount}]];
    let currentCount = 0;
    let start = 1;

    $("#viewMore").on("click", function(){
        const amount = 5;
        $.ajax({
            url: "/service/selectMyResHistory",
            type: "POST",
            dataType: "JSON",
            data: {
                memberNo: memberNo,
                start: start,
                amount: amount
            },
            success: function(data){
                console.log(data);

                $(data).each(function(index, item){
                    const li = $("<li>");
                    const detailLink = $("<a href='/member/myMedicalDetail?reservationNo="+item.reservationNo+"'>");
                    const badgeArea = $("<div class='badge_area'>");
                    const resStatus = $("<span class='badge'>");
                    const resType = $("<span class='res_type badge'>");
                    const memberName = $("<span class='name'>");
                    const btnArea = $("<div class='btn_area'>");
                    //예약 상태(예약 상태에 따라 필요한 버튼 생성 및 노출)
                    if(item.reservationStatus == 1){
                        resStatus.addClass("blue, outline");
                        resStatus.text("접수대기");
                        const ctaBtn = $("<a href='/service/cancelMyReservation' class='btn_secondary'>예약 취소</a>");
                        btnArea.append(ctaBtn);
                    }else if(item.reservationStatus == 2){
                        resStatus.addClass("red, outline");
                        resStatus.text("예약취소");
                    }else if(item.reservationStatus == 3){
                        resStatus.addClass("blue");
                        resStatus.text("예약확정");
                        const ctaBtn = $("<a href='/service/cancelMyReservation' class='btn_secondary'>예약 취소</a>");
                        btnArea.append(ctaBtn);
                    }else if(item.reservationStatus == 4){
                        resStatus.addClass("gray");
                        resStatus.text("진료완료");
                        if(item.reservationType == 2){
                            const ctaBtn = $("<a href='/service/payMedicalBills' class='btn_primary outline'>수납하기</a>");
                            btnArea.append(ctaBtn);
                        }else{
                            const ctaBtn = $("<a href='#' class='btn_primary outline'>리뷰 쓰기</a>");
                            btnArea.append(ctaBtn);
                        }
                    }else{
                        resStatus.addClass("gray");
                        resStatus.text("수납완료");
                        const ctaBtn1 = $("<a href='#' class='btn_primary'>처방전 보기</a>");
                        const ctaBtn2 = $("<a href='#' class='btn_primary outline'>리뷰 쓰기</a>");
                        btnArea.append(ctaBtn1).append(ctaBtn2);
                    }
                    //예약 타입(대면/비대면)
                    if(item.reservationType == 1){
                        resType.addClass("contact");
                        resType.text("대면진료");
                    }else{
                        resType.addClass("contactless");
                        resType.text("비대면진료");
                    }
                    //진료대상자 이름
                    if(item.childName != null){
                        memberName.text(item.childName);
                    }else{
                        memberName.text(item.memberName);
                    }
                    badgeArea.append(resStatus).append(resType).append(memberName);
                    //예약 정보(병원이름/예약일시)
                    const infoArea = $("<div class='info_area'>");
                    const hospitalName = $("<strong class='hospital_name'>");
                    hospitalName.text(item.hospitalName);
                    const resTime = $("<div class='res_time'>");
                    const resTimeDate = $("<span class='res_time_date'>");
                    const resTimeDay = $("<span class='res_time_day'>");
                    const resTimeTime = $("<span class='res_time_time'>");
                    resTimeDate.text(item.resTimeDate);
                    resTimeDay.text(item.resTimeDay);
                    resTimeTime.text(item.resTimeTime);
                    resTime.append(resTimeDate).append(resTimeDay).append(resTimeTime);
                    infoArea.append(hospitalName).append(resTime);

                    //합치기
                    detailLink.append(badgeArea);
                    detailLink.append(infoArea);
                    detailLink.append(btnArea);
                    li.append(detailLink);
                    $(".history_list").append(li);
                })

                start = start+amount;
                currentCount = currentCount+data.length;
                if(currentCount == totalCount){
                    $("#viewMore").hide();
                }
            },
            error: function(){
                console.log("에러");
            }
        })
    })
    $("#viewMore").click();
</script>
</body>
</html>